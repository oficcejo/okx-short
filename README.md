# OKX ETH 永续合约超短线做空机器人

本项目是一款基于 OKX 交易所 V5 API 开发的 ETH-USDT 永续合约策略交易机器人。采用 **SMMA120 均线压制 + 放量阴线** 策略，专为超短线做空设计，并集成了完整的历史数据回测系统。

## 🌟 核心特性

- **SMMA 策略引擎**：基于 SMMA120 周期平滑移动平均线，自动识别价格压力区间。
- **三重信号验证**：
  1. 价格处于 SMMA120 下方 0.5% 范围内。
  2. 1 分钟 K 线为阴线（收盘 < 开盘）。
  3. 成交量突增（默认 > 4000 ETH，volCcy 币种成交量，与OKX图表一致）。
- **自动化交易**：支持 50 倍杠杆自动开仓、OCO 止盈止损设置。
- **全流程回测**：内置历史 K 线下载工具，一键生成胜率、盈亏比、最大回撤等回测报告及权益曲线。
- **风险控制**：单笔投入固定金额，自动计算张数，严格执行 SMMA 上方 0.2% 止损。
- **佣金追踪**：内置 Broker Tag `c314b0aecb5bBCDE`。

## 📂 目录结构

```text
d:\www\okx\okx-short\
├── .env.example          # 环境配置模板
├── requirements.txt      # 依赖库清单
├── config.py             # 策略与连接参数配置
├── okx_client.py         # OKX API 封装客户端
├── smma_strategy.py      # SMMA 核心策略逻辑
├── trader.py             # 实时交易/监控主程序
├── backtester.py         # 历史数据回测引擎
├── download_data.py      # 历史行情下载工具
└── utils.py              # 日志与通用工具
```

## 🚀 快速开始

### 1. 环境准备

建议使用 Python 3.10+ 环境。

```bash
# 进入项目目录
cd d:\www\okx\okx-short

# 创建并激活虚拟环境
python -m venv venv
.\venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```

### 2. 配置说明

1. 复制 `.env.example` 为 `.env`。
2. 配置您的 OKX API 信息：

```ini
OKX_API_KEY=your_key
OKX_SECRET_KEY=your_secret
OKX_PASSPHRASE=your_passphrase
OKX_DEMO=true  # true 为模拟盘，false 为实盘
```

3. (可选) 修改 `config.py` 中的策略参数（如杠杆倍数、成交量阈值等）。

### 3. 下载数据与回测

在正式运行前，强烈建议先下载数据进行验证：

```bash
# 下载最近 7 天的 1分钟 K线数据
python download_data.py --days 7

# 运行回测系统
python backtester.py --data data/ETH_USDT_SWAP_1m_7d.csv
```

回测完成后将输出统计表格，并在 `data/` 目录下生成 `backtest_result.png` 权益曲线图。

### 4. 运行交易机器人

```bash
# 试运行（Dry-run 模式，只监控信号不实际下单）
python trader.py --dry-run

# 开始自动交易
python trader.py
```

## 📈 策略逻辑详解

- **入场**：当 1min K 线收盘价位于 `[SMMA120 * 0.995, SMMA120]` 之间，且当前 K 线为红色（阴线），且成交量 `vol > 4000` 时，触发市价做空。
- **止盈**：设置 OCO 订单，止盈价格为触发时的 `SMMA120 * 0.99`（盈利 1%）。
- **止损**：设置 OCO 订单，止损价格为触发时的 `SMMA120 * (1 + SL_PERCENT)`（SMMA 上方 0.2% 作为缓冲）。

## ⚠️ 免责声明

本程序提供的所有策略和代码仅供学习和研究使用。由于数字货币交易具有极高风险（尤其是 50 倍高杠杆），使用本程序产生的任何盈亏由使用者自行承担，开发者不承担任何法律责任。

**风险提示**：50倍杠杆下，2% 的反向波动即可导致爆仓，请务必在模拟盘充分测试。

参数设置示例：
SMMA_PERIOD = 120                   # SMMA 均线周期
ENTRY_RANGE = 0.005                 # 入场范围：SMMA 下方 0.2%
TP_PERCENT = 0.05                   # 止盈：SMMA 下方 2%
SL_PERCENT = 0.001                  # 止损：SMMA 上方 0.2%
VOLUME_THRESHOLD = 12000             # 成交量阈值 (volCcy-币种数量，单位ETH，与OKX图表一致)
ORDER_AMOUNT_USDT = 20              # 每次开仓投入 USDT
📊 回测报告
======================================================================
┌──────────────────────┬────────────────────────┐
│ 指标                   │ 值                      │
├──────────────────────┼────────────────────────┤
│ 初始资金                 │ 1000.00 USDT           │
│ 最终资金                 │ 1098.57 USDT           │
│ 总收益                  │ +104.0013 USDT         │
│ 收益率                  │ +9.86%                 │
│ 总手续费                 │ 5.3806 USDT            │
│ ──────────────────── │ ────────────────────   │
│ 总交易次数                │ 11                     │
│ 盈利次数                 │ 3                      │
│ 亏损次数                 │ 8                      │
│ 胜率                   │ 27.3%                  │
│ ──────────────────── │ ────────────────────   │
│ 平均盈利                 │ +44.9735 USDT          │
│ 平均亏损                 │ -3.8649 USDT           │
│ 盈亏比                  │ 4.36                   │
│ 最大回撤                 │ -3.40%                 │
│ 平均持仓时间               │ 0 days 06:47:54.545454 │
└──────────────────────┴────────────────────────┘

📝 交易明细 (共 11 笔)
----------------------------------------------------------------------
┌────┬───────────────────────────┬───────────────────────────┬───────────┬───────────┬─────────┬──────┐  
│    │ 开仓时间                      │ 平仓时间                      │       开仓价 │       平仓价 │     净盈亏 │ 原因   │
├────┼───────────────────────────┼───────────────────────────┼───────────┼───────────┼─────────┼──────┤  
│  0 │ 2026-02-17 22:38:00+08:00 │ 2026-02-18 00:01:00+08:00 │ 1973.8000 │ 1981.3000 │ -4.2448 │ 止损   │
│  1 │ 2026-02-18 01:10:00+08:00 │ 2026-02-18 02:20:00+08:00 │ 1967.0800 │ 1977.8900 │ -5.8980 │ 止损   │
│  2 │ 2026-02-18 08:47:00+08:00 │ 2026-02-18 11:32:00+08:00 │ 1984.0100 │ 1995.6000 │ -6.2951 │ 止损   │
│  3 │ 2026-02-18 18:34:00+08:00 │ 2026-02-19 21:45:00+08:00 │ 2004.4700 │ 1912.1500 │ 44.7679 │ 止盈   │
│  4 │ 2026-02-20 01:28:00+08:00 │ 2026-02-20 02:14:00+08:00 │ 1927.4900 │ 1930.9700 │ -2.2687 │ 止损   │
│  5 │ 2026-02-20 12:01:00+08:00 │ 2026-02-20 13:33:00+08:00 │ 1945.9000 │ 1954.1800 │ -4.7205 │ 止损   │
│  6 │ 2026-02-20 14:30:00+08:00 │ 2026-02-20 14:31:00+08:00 │ 1949.2700 │ 1952.1000 │ -1.9404 │ 止损   │
│  7 │ 2026-02-21 20:27:00+08:00 │ 2026-02-21 20:57:00+08:00 │ 1970.1000 │ 1974.9400 │ -2.9126 │ 止损   │
│  8 │ 2026-02-22 00:01:00+08:00 │ 2026-02-22 00:36:00+08:00 │ 1980.2100 │ 1984.5000 │ -2.6391 │ 止损   │
│  9 │ 2026-02-22 04:53:00+08:00 │ 2026-02-23 09:07:00+08:00 │ 1979.4400 │ 1887.9300 │ 45.2836 │ 止盈   │
│ 10 │ 2026-02-23 22:36:00+08:00 │ 2026-02-24 09:16:00+08:00 │ 1906.9800 │ 1819.7800 │ 44.8690 │ 止盈   │
└────┴───────────────────────────┴───────────────────────────┴───────────┴───────────┴─────────┴──────┘